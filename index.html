<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TT Not-Stars (Github)</title>
    
    <link rel="manifest" href="manifest.json">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

    <style>
        html, body {
  overscroll-behavior-y: contain;
}
    </style> 


    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base font for the application */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        /* New font for the title only - Shadows Into Light */
        @import url('https://fonts.googleapis.com/css2?family=Shadows+Into+Light&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Kranky&display=swap');
        /* Calculator Font */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #bababa; /* Updated Default Light Gray */
            min-height: 100vh;
            transition: background-color 0.5s ease; /* Smooth transition for color change */
             }   
        
        /* Calculator Variables */
        :root {
            --calc-bg: #d1d5db; /* Professional Grey */
            --screen-bg: #9eb89a;
            --screen-text: #1a2a1a;
            --btn-num: #ffffff;
            --btn-op: #f39c12;
            --btn-del: #e74c3c;
            --border-thick: 6px solid #000000;
        }

        .container {
            max-width: 1200px;
        }
        .grid-cell {
            padding: 0.5rem 0.2rem;
            height: auto;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem; 
            font-weight: 600;
            transition: all 0.2s;
            cursor: default;
            white-space: nowrap;
            flex: 1 1 0%;
            min-width: 0;
        }
        #count-grid > .flex, #time-grid > .flex, #div-count-grid > .flex, #div-time-grid > .flex {
            width: 100%;
        }
        /* Modal specific styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        /* Slider styling for a better look */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            margin: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4f46e5; /* Indigo 600 */
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        input#rgb-slider-r { background: linear-gradient(to right, #ffffff, #ff0000); }
        input#rgb-slider-g { background: linear-gradient(to right, #ffffff, #00ff00); }
        input#rgb-slider-b { background: linear-gradient(to right, #ffffff, #0000ff); }

        .fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .modal-hidden {
            display: none;
        }

        /* --- Calculator Specific Styles --- */
        .calculator {
            background: var(--calc-bg);
            padding: 20px;
            border-radius: 20px;
            border: var(--border-thick);
            box-shadow: 12px 12px 0px rgba(0, 0, 0, 1);
            width: 100%;
            max-width: 420px;
            margin: 0 auto; /* Center it */
        }

        .screen-container {
            background: var(--screen-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            border: var(--border-thick);
            box-shadow: inset 4px 4px 0px rgba(0,0,0,0.1);
            overflow: hidden; /* Contain the glass effect */
        }

        .screen-glass {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 10;
        }

        .question-display {
            font-family: 'Orbitron', sans-serif;
            color: var(--screen-text);
            font-size: 1.5rem;
            text-align: right;
            font-weight: 700;
            z-index: 5;
        }

        .answer-display {
            font-family: 'Orbitron', sans-serif;
            color: var(--screen-text);
            font-size: 3rem;
            text-align: right;
            font-weight: 700;
            min-height: 4.5rem;
            z-index: 5;
            overflow: hidden;
        }

        .calc-btn {
            background: var(--btn-num);
            border: var(--border-thick);
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: 800;
            color: #000000;
            transition: all 0.1s;
            cursor: pointer;
            padding: 15px 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 4px 4px 0px #000000;
        }

        .calc-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px #000000;
        }

        .btn-op {
            background: var(--btn-op);
        }

        .btn-del {
            background: var(--btn-del);
            color: white;
        }

        .stats-bar {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            color: var(--screen-text);
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 700;
            z-index: 5;
        }

        @keyframes flash-green {
            0% { background-color: var(--screen-bg); }
            50% { background-color: #2ecc71; }
            100% { background-color: var(--screen-bg); }
        }

        @keyframes flash-red {
            0% { background-color: var(--screen-bg); }
            50% { background-color: #e74c3c; }
            100% { background-color: var(--screen-bg); }
        }

        .correct-flash { animation: flash-green 0.5s ease-out; }
        .wrong-flash { animation: flash-red 0.5s ease-out; }

    </style>
</head>
<body>
    
    <div id="app-container" class="container mx-auto p-4 md:p-8">
        <!-- Page Header -->
        <header id="page-header" class="text-center mb-8">
            <h1 class="text-5xl md:text-6xl text-gray-900" style="font-family: 'Kranky';"><!--TT Not-Stars--></h1>

        </header>
        

        <div id="splashScreen" class="fixed inset-0 bg-[#789dcc] z-[100] flex flex-col items-center justify-center gap-8 p-6 text-center">
            <img src="tt-icon-512.png" alt="App Logo">
            <button id="enterBtn" class="px-12 py-4 bg-white text-black rounded-full font-bold text-lg hover:scale-105 transition-transform active:scale-95">
            Start
            </button>
        </div>

        <!-- Notification/Message Box -->
        <div id="message-box" class="hidden fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-xl z-50 transition-transform duration-300 transform translate-x-full"></div>

        <!-- PAGE 1: QUIZ & CONTROLS -->
        <div id="page-quiz" class="space-y-8">

            <!-- Step 1: Selection (White Box) -->
            <div id="selection-panel" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                
                <!-- Player Display (Moved Inside) -->
                <div id="selection-player-display" class="mb-4 text-sm text-gray-500 border-b pb-2 flex justify-between items-center">
                    <div>
                        <span class="font-semibold">Current Player:</span> 
                        <span id="current-player-display" class="text-indigo-600 font-bold">Please Select Player</span>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-4">Quiz Setup</h2>
                    
                <!-- Player Selection Panel -->
                <div id="player-selection-panel" class="mb-6 p-4 border rounded-xl bg-gray-50">
                        
                    <!-- Existing Player Selection -->
                    <div>
                        <label for="player-select" class="font-semibold mb-1 block text-gray-700">Select Existing Player:</label>
                        
                        <div class="relative">
                            <select 
                                id="player-select" 
                                class="w-full p-2 border-2 border-gray-300 rounded-lg bg-white text-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition" 
                                disabled
                            >
                                <option value="" disabled selected>-- Select a Player --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Button to open modal -->
                    <div class="mt-4 pt-4 border-t border-gray-200 flex justify-start">
                        <button 
                            id="show-new-player-modal-button" 
                            class="bg-white text-blue-600 font-semibold px-4 py-2 rounded-lg shadow-sm border border-gray-300 hover:bg-blue-50 hover:border-blue-400 transition"
                        >
                            + Create New Player
                        </button>
                    </div>
                </div>


                <!-- Operation Selector -->
                <div class="mb-6 p-4 border rounded-xl bg-gray-50">
                    <p class="font-semibold mb-2 text-gray-700">Choose Quiz Mode:</p>
                    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                        <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg shadow-sm border">
                            <input type="radio" name="operation-mode" value="multiplication" checked id="mode-mul" class="form-radio text-indigo-600 h-5 w-5">
                            <span class="text-gray-700 font-medium">Multiplication</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg shadow-sm border">
                            <input type="radio" name="operation-mode" value="division" id="mode-div" class="form-radio text-indigo-600 h-5 w-5">
                            <span class="text-gray-700 font-medium">Division</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 rounded-lg shadow-sm border">
                            <input type="radio" name="operation-mode" value="both" id="mode-both" class="form-radio text-indigo-600 h-5 w-5">
                            <span class="text-gray-700 font-medium">Both</span>
                        </label>
                    </div>
                </div>

                <!-- Select Tables Section -->
                <div class="mb-6 p-4 border rounded-xl bg-gray-50">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3">
                        <p class="font-semibold text-gray-700 mb-2 sm:mb-0">Select Tables:</p>
                        
                        
                    </div>

                    <div class="grid grid-cols-6 sm:grid-cols-12 gap-3" id="table-checkbox-container">
                        <!-- Checkboxes will be generated here -->
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-3 gap-3">
                        <button id="btn-select-all" class="bg-white text-blue-600 font-semibold py-2 rounded-lg shadow-sm border border-gray-300 hover:bg-blue-50 hover:border-blue-400 transition text-center">
                        All
                        </button>
                        <button id="btn-select-none" class="bg-white text-blue-600 font-semibold py-2 rounded-lg shadow-sm border border-gray-300 hover:bg-blue-50 hover:border-blue-400 transition text-center">
                        None
                        </button>
                        <button id="btn-lucky-dip" class="bg-white text-blue-600 font-semibold py-2 rounded-lg shadow-sm border border-gray-300 hover:bg-blue-50 hover:border-blue-400 transition text-center">
                        Lucky Dip
                        </button>
                    </div>
                </div>
                
                <button id="start-quiz-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Select Player and Tables to Start
                </button>
            </div>

            <!-- Step 2: Calculator Quiz Interface (Transparent / No Box) -->
            <div id="quiz-panel" class="hidden flex flex-col items-center">
                
                <div class="calculator">
                    <!-- Brand / Player Name -->
                    <div class="flex justify-between items-end mb-2">
                            <div class="text-gray-500 text-xs font-bold tracking-widest uppercase">TT Not-Stars Calc</div>
                            <div id="calc-player-brand" class="text-gray-700 text-sm font-bold tracking-wider uppercase font-mono">PLAYER</div>
                    </div>
                    
                    <div id="calc-screen" class="screen-container">
                        <div class="screen-glass"></div>
                        
                        <div class="stats-bar">
                            <span id="calc-progress-label">Q: 1/20</span>
                            <!-- Timer hidden from immediate view to match calc aesthetic, but tracked in BG -->
                            <span>Input</span> 
                        </div>
                        
                        <div id="question-text" class="question-display">READY?</div>
                        <div id="answer-input-display" class="answer-display">_</div>
                    </div>

                    <div class="grid grid-cols-4 gap-4">
                        <button class="calc-btn" onclick="addCalcInput('7')">7</button>
                        <button class="calc-btn" onclick="addCalcInput('8')">8</button>
                        <button class="calc-btn" onclick="addCalcInput('9')">9</button>
                        <button class="calc-btn btn-del" onclick="clearCalcInput()">C</button>

                        <button class="calc-btn" onclick="addCalcInput('4')">4</button>
                        <button class="calc-btn" onclick="addCalcInput('5')">5</button>
                        <button class="calc-btn" onclick="addCalcInput('6')">6</button>
                        <button class="calc-btn btn-op" onclick="deleteLastCalcInput()">&larr;</button>

                        <button class="calc-btn" onclick="addCalcInput('1')">1</button>
                        <button class="calc-btn" onclick="addCalcInput('2')">2</button>
                        <button class="calc-btn" onclick="addCalcInput('3')">3</button>
                        <button class="calc-btn btn-op row-span-2 flex items-center justify-center" onclick="submitAnswer()">ENT</button>

                        <button class="calc-btn col-span-2" onclick="addCalcInput('0')">0</button>
                        <button class="calc-btn" onclick="addCalcInput('.')">.</button>
                    </div>
                </div>
                
                <button id="end-quiz-button" class="mt-8 text-sm text-gray-700 font-bold hover:text-red-600 transition duration-150 underline">
                    End Quiz Early
                </button>
            </div>

            <!-- Step 3: Results (White Box) -->
            <div id="results-panel" class="hidden text-center bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <!-- Added Player Name Display for Results -->
                <p class="mb-2 text-gray-500 font-semibold">Player: <span id="results-player-name" class="text-indigo-600 font-bold"></span></p>

                <h2 class="text-4xl font-extrabold text-teal-600 mb-4">Quiz Complete!</h2>
                <p id="results-summary" class="text-xl text-gray-700 mb-6">You scored X out of 20.</p>
                <div id="results-details" class="text-left max-h-64 overflow-y-auto p-4 bg-gray-50 rounded-lg shadow-inner mb-6 border">
                    <!-- Detailed results list goes here -->
                </div>
                <button id="new-quiz-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl shadow-md transition duration-150 ease-in-out">
                    End Quiz
                </button>
            </div>

             <!-- Navigation to Page 2 -->
             <div class="flex justify-center mt-6">
                <button id="to-stats-btn" class="bg-white/80 hover:bg-white text-indigo-800 font-bold py-3 px-6 rounded-xl shadow-md border border-indigo-200 transition flex items-center gap-2 backdrop-blur-sm">
                    <span>View Progress & Settings</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                    </svg>
                </button>
            </div>

        </div> <!-- End Page 1 -->

        <!-- PAGE 2: STATS, SETTINGS & ADMIN -->
        <div id="page-stats" class="hidden space-y-8">

             <!-- Navigation Back to Page 1 -->
             <div class="flex justify-start mb-6">
                <button id="to-quiz-btn" class="bg-white/80 hover:bg-white text-indigo-800 font-bold py-2 px-4 rounded-xl shadow-md border border-indigo-200 transition flex items-center gap-2 backdrop-blur-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
                    </svg>
                    <span>Back to Quiz</span>
                </button>
            </div>

            <!-- Tracking Panel -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Progress tables for <span class="text-indigo-600" id="progress-player-name">Player</span></h2>
                <div class="space-y-6">
                    
                    <!-- Average Multiplication Time Grid -->
                    <div class="bg-slate-50 p-4 rounded-lg shadow-inner border">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Average Multiplication Response Time
                        </h3>
                        <p class="text-sm text-gray-500 mb-2" id="mul-time-subtitle">Rolling average of the <strong>last 5 attempts</strong> (Factor 1 across, Factor 2 down)</p>
                        <div>
                            <div id="time-grid" class="flex flex-col items-stretch">
                                <!-- Grid rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Average Division Time Grid -->
                    <div class="bg-slate-50 p-4 rounded-lg shadow-inner border">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Average Division Response Time
                        </h3>
                        <p class="text-sm text-gray-500 mb-2" id="div-time-subtitle">Rolling average of the <strong>last 5 attempts</strong> (Divisor across, Answer B down)</p>
                        <div>
                            <div id="div-time-grid" class="flex flex-col items-stretch">
                                <!-- Grid rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Total Questions Answered Box -->
                    <div class="bg-gray-100 p-4 rounded-lg shadow border border-gray-200">
                        <h3 class="text-xl font-semibold mb-1 text-gray-700 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Total Questions Answered
                        </h3>
                        <p id="total-questions-answered-display" class="text-4xl font-extrabold text-blue-800">0</p>
                    </div>

                </div>
            </div>
            
            <!-- Customization Panel (New) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Appearance Settings</h2>
                <!-- Updated button styling and wrapped in a div for alignment -->
                <div class="flex justify-start">
                    <button 
                        id="show-color-modal-button" 
                        class="bg-white text-blue-600 font-semibold px-4 py-2 rounded-lg shadow-sm border border-gray-300 hover:bg-blue-50 hover:border-blue-400 transition"
                    >
                        Change Background Color
                    </button>
                </div>
            </div>

            <!-- ADMIN BUTTONS -->
            <!-- Added disabled styles for when quiz is running -->
            <div class="flex justify-center mt-8 space-x-4">
                <button id="show-quiz-setup-button" class="text-xs text-gray-500 hover:text-gray-800 hover:underline px-4 py-2 rounded transition border border-transparent hover:border-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Quiz System Setup
                </button>
                <button id="manage-players-button" class="text-xs text-gray-500 hover:text-gray-800 hover:underline px-4 py-2 rounded transition border border-transparent hover:border-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Manage Players
                </button>
                <button id="show-raw-data-button" class="text-xs text-gray-500 hover:text-gray-800 hover:underline px-4 py-2 rounded transition border border-transparent hover:border-gray-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Show Player Data
                </button>
            </div>
            
        </div> <!-- End Page 2 -->
    </div>
    
    <!-- Manage Players Modal -->
    <div id="manage-players-modal" class="modal hidden">
        <div class="modal-content w-full md:w-3/4 lg:w-1/2">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Manage Players</h3>
                <button id="close-manage-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            
            <div id="manage-players-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <!-- Player list items will be injected here -->
            </div>
            
            <div class="mt-6 text-right">
                <button onclick="document.getElementById('manage-players-modal').classList.add('hidden')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Raw Data Modal -->
<div id="raw-data-modal" class="modal hidden">
    <div class="modal-content w-full md:w-3/4 lg:w-1/2">

        <!-- Header -->
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-bold text-gray-800">
                Edit Raw Local Data for
                <span id="modal-player-name" class="text-indigo-600"></span>
            </h3>
            <button
                id="close-modal-button"
                class="text-gray-500 hover:text-gray-800 text-2xl font-bold">
                &times;
            </button>
        </div>

        <!-- Editor -->
        <textarea
            id="raw-data-content"
            class="w-full h-96 bg-gray-100 p-4 rounded-lg text-sm font-mono overflow-auto resize-none">
        </textarea>

        <p
            id="raw-data-error"
            class="text-red-600 text-sm mt-2 hidden">
            Invalid JSON format or corrupted data structure.
        </p>

        <!-- Footer (NEW) -->
        <div class="mt-6 flex justify-end space-x-3">
            <button
                onclick="closeRawDataModal()"
                class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg transition">
                Cancel
            </button>

            <button
                id="save-modal-button"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg shadow transition disabled:opacity-50">
                Save Changes
            </button>
        </div>

    </div>
</div>


    <!-- New Player Modal -->
    <div id="new-player-modal" class="modal hidden">
        <div class="modal-content w-full md:w-1/2 lg:w-1/3">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Create New Player Profile</h3>
                <button id="close-new-player-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            
            <label for="new-player-name-input" class="font-semibold mb-1 block text-gray-700">Player Name:</label>
            <div class="flex space-x-2 mt-2">
                <input 
                    type="text" 
                    id="new-player-name-input" 
                    placeholder="Enter new name (e.g., Alex)" 
                    class="flex-grow text-lg p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition"
                    required
                >
                <button id="set-new-player-button" class="flex-shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg shadow-md transition disabled:opacity-50" disabled>
                    Create
                </button>
            </div>
            <p id="new-player-error" class="text-red-600 text-sm mt-2 hidden">Player name must be at least 2 characters long.</p>
        </div>
    </div>
    
    <!-- Background Color Modal (New with Sliders) -->
    <div id="color-modal" class="modal hidden">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Select Custom Background Color (RGB)</h3>
                <button id="close-color-modal-button" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>

            <p class="mb-4 text-gray-600">Use the sliders below to mix your perfect background color.</p>

            <!-- Color Preview -->
            <div id="color-preview" class="w-full h-16 rounded-xl mb-6 shadow-inner border-2 border-gray-300 transition-colors duration-150" style="background-color: rgb(186, 186, 186);"></div>

            <!-- Red Slider -->
            <div class="mb-4">
                <label class="font-semibold text-red-600 flex justify-between items-center">
                    Red (R): <span id="rgb-value-r">186</span>
                </label>
                <input type="range" id="rgb-slider-r" min="0" max="255" value="186" class="accent-red-500">
            </div>

            <!-- Green Slider -->
            <div class="mb-4">
                <label class="font-semibold text-green-600 flex justify-between items-center">
                    Green (G): <span id="rgb-value-g">186</span>
                </label>
                <input type="range" id="rgb-slider-g" min="0" max="255" value="186" class="accent-green-500">
            </div>

            <!-- Blue Slider -->
            <div class="mb-6">
                <label class="font-semibold text-blue-600 flex justify-between items-center">
                    Blue (B): <span id="rgb-value-b">186</span>
                </label>
                <input type="range" id="rgb-slider-b" min="0" max="255" value="186" class="accent-blue-500">
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-color-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg transition">Cancel</button>
                <button id="apply-color-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg transition">Apply Color</button>
            </div>
        </div>
    </div>
    
    <!-- Admin Auth Modal (NEW) -->
    <div id="admin-auth-modal" class="modal hidden">
        <div class="modal-content w-full max-w-sm">
            <div class="text-center">
                <div class="mb-4 text-indigo-600">
                    <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Admin Verification</h3>
                <p class="text-sm text-gray-600 mb-6">Please enter the admin code to proceed with this action.</p>
                
                <input type="password" id="admin-code-input" class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-lg mb-4 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Enter Code" maxlength="10">
                <p id="admin-auth-error" class="text-red-500 text-sm mb-4 hidden">Incorrect Admin Code.</p>

                <div class="flex space-x-3">
                    <button onclick="closeAdminAuthModal()" class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Cancel</button>
                    <button onclick="confirmAdminAuth()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Verify</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Are You Sure Modal -->
    <div id="exitModal" class="modal hidden" >
        <div class="modal-content w-full md:w-1/3 lg:w-1/2">

            <h3 class="text-xl font-bold text-gray-800">Leave app?</h3>
            <p class="text-slate-400 mb-8">Leaving now will erase your current session data. Do you want to stay?</p>
            <p class="text-slate-400 mb-8">Swipe again to exit</p>
            
            <div class="grid grid-cols-2 gap-3">
                <button id="stayBtn" class="py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-bold transition-colors">
                    Stay
                </button>
                <!--<button id="leaveBtn" class="py-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-2xl font-bold transition-colors">
                    Leave
                </button>-->
            </div>
        </div>
    </div>

    
    <!-- Quiz Setup Modal (NEW) -->
    <div id="quiz-setup-modal" class="modal hidden">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Quiz System Parameters Setup</h3>
                <button id="close-quiz-setup-button" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            
            <p class="mb-4 text-sm text-gray-600">These settings are applied globally for all players.</p>
            
            <form id="quiz-setup-form" class="space-y-4 max-h-[60vh] overflow-y-auto px-1">
                


                <div class="flex items-center gap-4">
                    <label for="totalQuestions" class="w-2/3 font-medium text-gray-700">
                        Total Questions per Quiz
                    </label>
                    <input
                        type="number"
                        id="totalQuestions"
                        name="totalQuestions"
                        min="5"
                        max="100"
                        class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 text-center"
                        required
                    >
                </div>



                <div class="flex items-center gap-4">
                    <label for="weightThresholdYellow" class="w-2/3 font-medium text-gray-700">
                        Intermediate / Yellow Time Threshold (s)
                    </label>
                    <input
                        type="number"
                        id="weightThresholdYellow"
                        name="weightThresholdYellow"
                        step="0.1"
                        min="1"
                        max="20"
                        class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 text-center"
                        required
                    >
                </div>

                <div class="flex items-center gap-4">
                    <label for="weightThresholdRed" class="w-2/3 font-medium text-gray-700">
                        Poor / Red Time Threshold (s)
                    </label>
                    <input
                        type="number"
                        id="weightThresholdRed"
                        name="weightThresholdRed"
                        step="0.1"
                        min="1"
                        max="60"
                        class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 text-center"
                        required
                    >
                </div>

                <div class="flex items-center gap-4">
                    <label for="weightFactorIntermediate" class="w-2/3 font-medium text-gray-700">
                        Intermediate / Yellow Weight Factor
                    </label>
                    <input
                        type="number"
                        id="weightFactorIntermediate"
                        name="weightFactorIntermediate"
                        min="1"
                        max="20"
                        class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 text-center"
                        required
                    >
                </div>

                <div class="flex items-center gap-4">
                    <label for="weightFactorPoor" class="w-2/3 font-medium text-gray-700">
                        Poor / Red Weight Factor
                    </label>
                    <input
                        type="number"
                        id="weightFactorPoor"
                        name="weightFactorPoor"
                        min="1"
                        max="20"
                        class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 text-center"
                        required
                    >
                </div>

                <div class="flex items-center gap-4">
                    <label for="weightFactorNew" class="w-2/3 font-medium text-gray-700">
                        New / Unanswered Weight Factor
                    </label>
                    <input
                        type="number"
                        id="weightFactorNew"
                        name="weightFactorNew"
                        min="1"
                        max="20"
                        class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 text-center"
                        required
                    >
                </div>

                <div class="flex items-center gap-4">
                    <label for="penaltyTime" class="w-2/3 font-medium text-gray-700">
                        Incorrect Answer Penalty Time (s)
                    </label>
                    <input
                        type="number"
                        id="penaltyTime"
                        name="penaltyTime"
                        step="0.1"
                        min="1"
                        max="60"
                        class="w-24 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 text-center"
                        required
                    >
                </div>

                <div class="bg-red-50 p-4 rounded-lg border border-red-100 mb-4">
                    <!--<h4 class="font-bold text-red-800 mb-2 text-sm uppercase">Security Settings</h4>-->
                    <div class="flex items-center gap-4">
                        <label for="adminCode" class="w-2/3 font-medium text-gray-700">
                            Admin Access Code
                        </label>
                        <input
                            type="text"
                            id="adminCode"
                            name="adminCode"
                            placeholder="1234"
                            class="w-32 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 text-center font-mono"
                            required
                        >
                    </div>
                </div>

                <!-- Footer -->
                <div class="mt-8 flex justify-between items-center border-t pt-4">
                    <button
                        id="reset-system-params-button"
                        type="button"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded-lg transition shadow-md"
                    >
                        Reset to Default Values
                    </button>

                    <button
                        id="save-system-params-button"
                        type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-2 rounded-lg transition shadow-md"
                    >
                        Save Parameters
                    </button>
                </div>

            </form>

        </div>
    </div>

    <script>

        // --- CONSTANTS ---
        const LS_KEY = 'tt_not_stars_data_v2';
        const SYSTEM_PARAMS_KEY = '_system_params'; // Key to store global settings
        const QUIZ_STATE_KEY = 'tt_quiz_state_local'; 
        
        // Default System Parameters (NEW CENTRALIZED DEFAULTS)
        const TOTAL_QUESTIONS_DEFAULT = 20;
        const PENALTY_TIME_DEFAULT = 10.0;
        const ADMIN_CODE_DEFAULT = "1234";
        const WEIGHT_THRESHOLD_YELLOW_DEFAULT = 3.0;
        const WEIGHT_THRESHOLD_RED_DEFAULT = 9.0;
        const WEIGHT_FACTOR_GOOD = 1.0; // Keeping this one constant
        const WEIGHT_FACTOR_INTERMEDIATE_DEFAULT = 2.0;
        const WEIGHT_FACTOR_POOR_DEFAULT = 4.0;
        const WEIGHT_FACTOR_NEW_DEFAULT = 4.0;

        const DEFAULT_SYSTEM_PARAMS = {
            totalQuestions: TOTAL_QUESTIONS_DEFAULT,
            penaltyTime: PENALTY_TIME_DEFAULT,
            adminCode: ADMIN_CODE_DEFAULT,
            weightThresholdYellow: WEIGHT_THRESHOLD_YELLOW_DEFAULT,
            weightThresholdRed: WEIGHT_THRESHOLD_RED_DEFAULT,
            weightFactorIntermediate: WEIGHT_FACTOR_INTERMEDIATE_DEFAULT,
            weightFactorPoor: WEIGHT_FACTOR_POOR_DEFAULT,
            weightFactorNew: WEIGHT_FACTOR_NEW_DEFAULT,
        };

        // --- STATE MANAGEMENT ---
        let isDataLoaded = false; 
        let isRestoring = false;
        let currentPlayerName = null;
        let currentOperationMode = 'multiplication';
        let pendingAdminAction = null; // Store the function to run after admin auth
        
        const ROLLING_WINDOW = 5; 
        
        // RGB equivalent of #bababa is rgb(186, 186, 186)
        const DEFAULT_COLOR_RGB = 'rgb(186, 186, 186)';
        const DEFAULT_COLOR_R = 186;
        const DEFAULT_COLOR_G = 186;
        const DEFAULT_COLOR_B = 186;

        // Data Structure
        const DEFAULT_PLAYER_DATA = {
            mulTimes: {},  
            divTimes: {}, 
            totalAnswered: 0, 
            backgroundColor: DEFAULT_COLOR_RGB, 
        };
        // Global system parameters are stored here
        let systemParams = {};
        // In local storage version, we hold all players in memory
        let allPlayersData = {}; 
        let globalData = JSON.parse(JSON.stringify(DEFAULT_PLAYER_DATA));

        // --- UI ELEMENTS ---
        const body = document.body;
        const pageHeader = document.getElementById('page-header'); 
        
        // Page Views
        const pageQuiz = document.getElementById('page-quiz');
        const pageStats = document.getElementById('page-stats');
        const toStatsBtn = document.getElementById('to-stats-btn');
        const toQuizBtn = document.getElementById('to-quiz-btn');

        // New Player Modal Elements
        const newPlayerModal = document.getElementById('new-player-modal');
        const showNewPlayerModalButton = document.getElementById('show-new-player-modal-button');
        const closeNewPlayerModalButton = document.getElementById('close-new-player-modal-button');
        const newPlayerNameInput = document.getElementById('new-player-name-input');
        const setNewPlayerButton = document.getElementById('set-new-player-button');
        const newPlayerError = document.getElementById('new-player-error');
        
        // Manage Players Modal Elements
        const managePlayersModal = document.getElementById('manage-players-modal');
        const managePlayersButton = document.getElementById('manage-players-button');
        const closeManageModalButton = document.getElementById('close-manage-modal-button');
        const managePlayersList = document.getElementById('manage-players-list');

        // Color Modal Elements
        const colorModal = document.getElementById('color-modal');
        const showColorModalButton = document.getElementById('show-color-modal-button');
        const closeColorModalButton = document.getElementById('close-color-modal-button');
        const applyColorButton = document.getElementById('apply-color-button');
        const cancelColorButton = document.getElementById('cancel-color-button');
        const colorPreview = document.getElementById('color-preview');
        const sliderR = document.getElementById('rgb-slider-r');
        const sliderG = document.getElementById('rgb-slider-g');
        const sliderB = document.getElementById('rgb-slider-b');
        const valueR = document.getElementById('rgb-value-r');
        const valueG = document.getElementById('rgb-value-g');
        const valueB = document.getElementById('rgb-value-b');
        
        // Quiz Setup Modal Elements (NEW)
        const quizSetupModal = document.getElementById('quiz-setup-modal');
        const showQuizSetupButton = document.getElementById('show-quiz-setup-button');
        const closeQuizSetupButton = document.getElementById('close-quiz-setup-button');
        const quizSetupForm = document.getElementById('quiz-setup-form');
        const saveSystemParamsButton = document.getElementById('save-system-params-button');
        const resetSystemParamsButton = document.getElementById('reset-system-params-button');
        const totalQuestionsInput = document.getElementById('totalQuestions');
        const penaltyTimeInput = document.getElementById('penaltyTime');
        const adminCodeInput = document.getElementById('adminCode'); // Config Input
        const weightThresholdYellowInput = document.getElementById('weightThresholdYellow');
        const weightThresholdRedInput = document.getElementById('weightThresholdRed');
        const weightFactorIntermediateInput = document.getElementById('weightFactorIntermediate');
        const weightFactorPoorInput = document.getElementById('weightFactorPoor');
        const weightFactorNewInput = document.getElementById('weightFactorNew');
        
        const currentPlayerDisplay = document.getElementById('current-player-display');
        const progressPlayerName = document.getElementById('progress-player-name');
        const playerSelect = document.getElementById('player-select'); 
        const selectionPanel = document.getElementById('selection-panel');
        const quizPanel = document.getElementById('quiz-panel');
        const resultsPanel = document.getElementById('results-panel');
        const startQuizButton = document.getElementById('start-quiz-button');
        const endQuizButton = document.getElementById('end-quiz-button');
        
        const newQuizButton = document.getElementById('new-quiz-button');
        const questionText = document.getElementById('question-text');
        
        const resultsSummary = document.getElementById('results-summary');
        const resultsDetails = document.getElementById('results-details');
        const messageBox = document.getElementById('message-box');
        const tableCheckboxContainer = document.getElementById('table-checkbox-container'); 
        const totalQuestionsAnsweredDisplay = document.getElementById('total-questions-answered-display');
        const showRawDataButton = document.getElementById('show-raw-data-button'); 
        const rawDataModal = document.getElementById('raw-data-modal');           
        const modalPlayerName = document.getElementById('modal-player-name');       
        const rawDataContent = document.getElementById('raw-data-content');         
        const closeModalButton = document.getElementById('close-modal-button');     
        const saveModalButton = document.getElementById('save-modal-button');     
        const rawDataError = document.getElementById('raw-data-error');             
        
        // Calculator specific elements
        const calcPlayerBrand = document.getElementById('calc-player-brand');
        const calcProgressLabel = document.getElementById('calc-progress-label');
        const calcScreen = document.getElementById('calc-screen');
        const answerInputDisplay = document.getElementById('answer-input-display');
        const selectionPlayerDisplay = document.getElementById('selection-player-display');

        // Admin Modal Elements
        const adminAuthModal = document.getElementById('admin-auth-modal');
        const adminCodeAuthInput = document.getElementById('admin-code-input'); // Auth input
        const adminAuthError = document.getElementById('admin-auth-error');

        // --- QUIZ LOGIC ---
        let selectedTables = [];
        let currentQuestionIndex = 0;
        let quizQuestions = [];
        let quizStartTime = 0;
        let score = 0;
        let currentQuestion = null;
        let awaitingNext = false;
        let currentCalcInput = "";
        
        // --- NAVIGATION LOGIC ---
        function showPage(pageName) {
            if (pageName === 'quiz') {
                pageQuiz.classList.remove('hidden');
                pageStats.classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (pageName === 'stats') {
                pageQuiz.classList.add('hidden');
                pageStats.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // --- LOCAL STORAGE FUNCTIONS ---
        
        function loadAllData() {
            try {
                const stored = localStorage.getItem(LS_KEY);
                if (stored) {
                    allPlayersData = JSON.parse(stored);
                } else {
                    allPlayersData = {};
                }
                
                // 1. Load System Parameters
                systemParams = allPlayersData[SYSTEM_PARAMS_KEY] || JSON.parse(JSON.stringify(DEFAULT_SYSTEM_PARAMS));
                // Ensure system params exist in the store object for saving
                allPlayersData[SYSTEM_PARAMS_KEY] = systemParams;

                isDataLoaded = true;
            } catch (e) {
                console.error("Failed to load local storage data", e);
                allPlayersData = {};
                systemParams = JSON.parse(JSON.stringify(DEFAULT_SYSTEM_PARAMS));
                showMessage("Error loading data from local storage", false);
            }
        }

        function saveAllData() {
            try {
                localStorage.setItem(LS_KEY, JSON.stringify(allPlayersData));
            } catch (e) {
                console.error("Failed to save to local storage", e);
                showMessage("Error saving data! Storage might be full.", false);
            }
        }
        
        // --- ADMIN AUTH FUNCTIONS (NEW) ---
        function requestAdminAuth(action) {
            pendingAdminAction = action;
            adminCodeAuthInput.value = '';
            adminAuthError.classList.add('hidden');
            adminAuthModal.classList.remove('hidden');
            adminCodeAuthInput.focus();
        }

        function closeAdminAuthModal() {
            adminAuthModal.classList.add('hidden');
            pendingAdminAction = null;
        }

        function confirmAdminAuth() {
            const enteredCode = adminCodeAuthInput.value;
            const currentCode = systemParams.adminCode || ADMIN_CODE_DEFAULT;

            if (enteredCode === currentCode) {
                // Correct code
                // Capture the action locally because closeAdminAuthModal() will clear the global variable
                const actionToRun = pendingAdminAction; 
                
                closeAdminAuthModal();
                
                if (typeof actionToRun === 'function') {
                    actionToRun();
                }
            } else {
                // Incorrect code
                adminAuthError.classList.remove('hidden');
                adminCodeAuthInput.value = '';
                adminCodeAuthInput.focus();
            }
        }

        // --- SYSTEM PARAMETER FUNCTIONS ---
        
        function openQuizSetupModal() {
            loadSystemParamsToModal();
            quizSetupModal.classList.remove('hidden');
        }

        function closeQuizSetupModal() {
            quizSetupModal.classList.add('hidden');
        }

        function loadSystemParamsToModal() {
            totalQuestionsInput.value = systemParams.totalQuestions;
            penaltyTimeInput.value = (systemParams.penaltyTime !== undefined) ? systemParams.penaltyTime : PENALTY_TIME_DEFAULT;
            adminCodeInput.value = systemParams.adminCode || ADMIN_CODE_DEFAULT;
            weightThresholdYellowInput.value = systemParams.weightThresholdYellow;
            weightThresholdRedInput.value = systemParams.weightThresholdRed;
            weightFactorIntermediateInput.value = systemParams.weightFactorIntermediate;
            weightFactorPoorInput.value = systemParams.weightFactorPoor;
            weightFactorNewInput.value = systemParams.weightFactorNew;
        }
        
        function saveSystemParams() {
            const newParams = {
                totalQuestions: parseInt(totalQuestionsInput.value),
                penaltyTime: parseFloat(penaltyTimeInput.value),
                adminCode: adminCodeInput.value.trim() || ADMIN_CODE_DEFAULT,
                weightThresholdYellow: parseFloat(weightThresholdYellowInput.value),
                weightThresholdRed: parseFloat(weightThresholdRedInput.value),
                weightFactorIntermediate: parseInt(weightFactorIntermediateInput.value),
                weightFactorPoor: parseInt(weightFactorPoorInput.value),
                weightFactorNew: parseInt(weightFactorNewInput.value),
            };

            // Basic validation
            if (newParams.weightThresholdYellow >= newParams.weightThresholdRed) {
                showMessage("Yellow Threshold must be less than Red Threshold.", false);
                return;
            }
            if (newParams.totalQuestions < 5) {
                showMessage("Total questions must be at least 5.", false);
                return;
            }

            // Update global state and persist
            systemParams = newParams;
            allPlayersData[SYSTEM_PARAMS_KEY] = systemParams;
            saveAllData();
            
            // UI Updates
            updateQuizUIParams();
            renderGrids(); // RE-RENDER GRIDS TO APPLY NEW COLORS
            
            closeQuizSetupModal();
            showMessage("Quiz parameters updated successfully!", true);
        }

        function resetSystemParams() {
            systemParams = JSON.parse(JSON.stringify(DEFAULT_SYSTEM_PARAMS));
            allPlayersData[SYSTEM_PARAMS_KEY] = systemParams;
            saveAllData();
            
            loadSystemParamsToModal(); // Update modal UI immediately
            updateQuizUIParams();
            renderGrids(); // Re-render grids for default colors
            showMessage("Quiz parameters reset to default values.", true);
        }

        function updateQuizUIParams() {
             // Update the Total Questions displayed in the quiz panel
            // totalQuestionsSpan.textContent = systemParams.totalQuestions; 
            // NOTE: Span removed in calc update, logic handles it in renderQuestion
        }
        
        // --- QUIZ ACTIVE STATE MANAGEMENT ---
        function setQuizActiveState(isActive) {
            // Setup and Manage buttons are disabled when quiz is active
            showQuizSetupButton.disabled = isActive;
            managePlayersButton.disabled = isActive;
            
            // Raw data button is disabled if quiz active OR no player selected
            if (isActive) {
                showRawDataButton.disabled = true;
                toStatsBtn.disabled = true; // Disable navigation to stats during quiz
                toStatsBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                // If quiz not active, only enable if player exists
                showRawDataButton.disabled = (currentPlayerName === null);
                toStatsBtn.disabled = false;
                toStatsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- COLOR FUNCTIONS ---

        /**
         * Parses an RGB string (e.g., "rgb(139, 0, 0)") into an object {r, g, b}.
         * Defaults to the initial background color if parsing fails.
         */
        function parseRgbString(rgbString) {
            // Default is the new body color: Light Gray (rgb(186, 186, 186))
            const defaultRgb = { r: DEFAULT_COLOR_R, g: DEFAULT_COLOR_G, b: DEFAULT_COLOR_B }; 

            if (!rgbString || !rgbString.startsWith('rgb')) {
                return defaultRgb;
            }
            const matches = rgbString.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (matches && matches.length === 4) {
                return {
                    r: parseInt(matches[1]),
                    g: parseInt(matches[2]),
                    b: parseInt(matches[3])
                };
            }
            return defaultRgb; 
        }

        /**
         * Saves the color preference to the currently active player's data.
         * @param {string} rgbColorString The color string in "rgb(r, g, b)" format.
         */
        function savePlayerColorPreference(rgbColorString) {
            if (!currentPlayerName) return;
            
            globalData.backgroundColor = rgbColorString; // Update active session data
            allPlayersData[currentPlayerName] = globalData; // Update the main store
            saveAllData(); // Commit to localStorage
            applyBackgroundColor(rgbColorString); // Apply immediately
        }

        /**
         * Applies the color and adjusts header text color for contrast.
         * Uses perceived luminance formula for contrast check.
         * L = 0.2126*R + 0.7152*G + 0.0722*B
         */
        function applyBackgroundColor(colorString) {
            body.style.backgroundColor = colorString;
            
            const { r, g, b } = parseRgbString(colorString);
            
            // Calculate perceived luminance
            const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b);

            // Use a threshold (e.g., 120) to decide between light and dark text
            const luminanceThreshold = 120; // Changed to 120 for better distinction with light gray

            // Remove previous text classes
            const h1Element = pageHeader.querySelector('h1');
            if (h1Element) {
                h1Element.classList.remove('text-gray-900', 'text-gray-300');
            
                if (luminance < luminanceThreshold) {
                    h1Element.classList.add('text-gray-300'); // Light text for dark background
                } else {
                    h1Element.classList.add('text-gray-900'); // Dark text for light background
                }
            }
        }

        function updateColorDisplay() {
            const r = sliderR.value;
            const g = sliderG.value;
            const b = sliderB.value;

            valueR.textContent = r;
            valueG.textContent = g;
            valueB.textContent = b;

            const colorString = `rgb(${r}, ${g}, ${b})`;
            colorPreview.style.backgroundColor = colorString;
        }
        
        function openColorModal() {
            // Get the current player's saved background color
            const currentColor = globalData.backgroundColor || DEFAULT_COLOR_RGB;
            const { r, g, b } = parseRgbString(currentColor);

            // Set sliders to current values
            sliderR.value = r;
            sliderG.value = g;
            sliderB.value = b;

            // Update preview and text based on initial slider values
            updateColorDisplay(); 

            colorModal.classList.remove('hidden');
        }

        function closeColorModal() {
            colorModal.classList.add('hidden');
        }

        // --- PLAYER FUNCTIONS ---

        function setPlayerProfile(name, suppressUI = false) {
            closeNewPlayerModal(); 
            const normalizedName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
            currentPlayerName = normalizedName;
            
            // Check if player exists in local data, if not create
            if (!allPlayersData[normalizedName]) {
                allPlayersData[normalizedName] = JSON.parse(JSON.stringify(DEFAULT_PLAYER_DATA));
                saveAllData();
            }

            // Set global data for current session
            globalData = allPlayersData[normalizedName];
            
            // Migration Logic (Ensure history array exists for existing entries)
            [globalData.mulTimes, globalData.divTimes].forEach(dataset => {
                for (const key in dataset) {
                    const entry = dataset[key];
                    if (!entry.history && entry.totalTime !== undefined && entry.count > 0) {
                        const avg = entry.totalTime / entry.count;
                        const count = Math.min(entry.count, ROLLING_WINDOW);
                        entry.history = Array(count).fill(avg);
                        delete entry.totalTime; // Clean up old field
                    } else if (!entry.history) {
                        entry.history = [];
                    }
                }
            });

            // Ensure color field exists and apply the player's color preference
            if (!globalData.hasOwnProperty('backgroundColor')) {
                globalData.backgroundColor = DEFAULT_COLOR_RGB; 
            }
            applyBackgroundColor(globalData.backgroundColor);
            
            currentPlayerDisplay.textContent = currentPlayerName;
            progressPlayerName.textContent = currentPlayerName;
            calcPlayerBrand.textContent = currentPlayerName;
            
            // showRawDataButton state managed via setQuizActiveState in other flows, 
            // but here we ensure it is enabled if no quiz is running (default state)
            if (!isRestoring) {
                 showRawDataButton.disabled = false;
            }
            
            if (!suppressUI) {
                newPlayerNameInput.value = '';
                setNewPlayerButton.disabled = true;
                refreshPlayerList();
                showMessage(`Welcome, ${currentPlayerName}!`, true); 
            } else {
                refreshPlayerList();
            }

            renderGrids();
            updateSelectedTables(); 
        }
        
        function refreshPlayerList() {
            const players = Object.keys(allPlayersData)
                .filter(key => key !== SYSTEM_PARAMS_KEY); // Exclude system params key
            renderPlayerList(players);
            updateSelectedTables(); 
        }
        
        function renderPlayerList(players) {
            const currentSelection = playerSelect.value;
            playerSelect.innerHTML = '<option value="" disabled selected>-- Select a Player --</option>'; 

            if (players.length === 0) {
                playerSelect.disabled = true;
                return;
            }
            
            playerSelect.disabled = false;
            players.sort((a, b) => a.localeCompare(b));

            players.forEach(name => {
                const option = document.createElement('option');
                option.textContent = name;
                option.value = name;
                
                if (name === currentPlayerName || name === currentSelection) {
                    option.selected = true; 
                    playerSelect.value = name;
                }

                playerSelect.appendChild(option);
            });
            
            if (currentPlayerName) {
                // If the currently selected player no longer exists (deleted externally), reset.
                if (!allPlayersData[currentPlayerName]) {
                     playerSelect.value = "";
                     currentPlayerDisplay.textContent = "Please Select Player";
                     progressPlayerName.textContent = "Player";
                     calcPlayerBrand.textContent = "PLAYER";
                     currentPlayerName = null;
                     globalData = JSON.parse(JSON.stringify(DEFAULT_PLAYER_DATA));
                     // Reset to default color when no user is active
                     applyBackgroundColor(DEFAULT_PLAYER_DATA.backgroundColor);
                     renderGrids();
                     showRawDataButton.disabled = true;
                     updateSelectedTables();
                } else {
                    playerSelect.value = currentPlayerName;
                }
            } else {
                 // Ensure the prompt is selected when no player is active and apply default color
                 playerSelect.value = ""; 
                 applyBackgroundColor(DEFAULT_PLAYER_DATA.backgroundColor);
            }
        }

        // --- NEW PLAYER MODAL FUNCTIONS ---

        function showNewPlayerModal() {
            newPlayerError.classList.add('hidden');
            newPlayerNameInput.value = '';
            setNewPlayerButton.disabled = true;
            newPlayerModal.classList.remove('hidden');
            newPlayerNameInput.focus();
        }
        
        function closeNewPlayerModal() {
            newPlayerModal.classList.add('hidden');
        }

        function validateAndCreatePlayer() {
            const newName = newPlayerNameInput.value.trim();
            if (newName.length < 2) { 
                newPlayerError.textContent = "Player name must be at least 2 characters long.";
                newPlayerError.classList.remove('hidden');
                return; 
            }
            newPlayerError.classList.add('hidden');
            setPlayerProfile(newName);
        }

        // --- MANAGE PLAYERS MODAL FUNCTIONS (UPDATED FOR ADMIN AUTH) ---
        
        function handleResetClick(btn) {
            const player = btn.dataset.player;
            requestAdminAuth(() => resetPlayerStats(player));
        }

        function openManagePlayersModal() {
            // Filter out system params from the list
            const players = Object.keys(allPlayersData)
                .filter(key => key !== SYSTEM_PARAMS_KEY)
                .sort();

            managePlayersList.innerHTML = '';

            if (players.length === 0) {
                managePlayersList.innerHTML = '<p class="text-gray-500 italic text-center p-4">No players found.</p>';
            } else {
                players.forEach(player => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center p-3 border-b border-gray-100 hover:bg-gray-50 rounded';
                    row.innerHTML = `
                        <span class="font-semibold text-gray-700">${player}</span>
                        <div class="space-x-2 flex">
                            <button 
                                class="reset-btn text-xs bg-yellow-100 text-yellow-700 px-3 py-2 rounded hover:bg-yellow-200 font-medium transition w-24 text-center" 
                                data-player="${player}" 
                            >
                                Reset Stats
                            </button>
                            <button class="delete-btn text-xs bg-red-100 text-red-700 px-3 py-2 rounded hover:bg-red-200 font-medium transition w-20 text-center" data-player="${player}">
                                Delete
                            </button>
                        </div>
                    `;
                    managePlayersList.appendChild(row);
                });
            }

            managePlayersList.querySelectorAll('.reset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleResetClick(e.target));
            });

            managePlayersList.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => handleDeleteClick(e.target));
            });

            managePlayersModal.classList.remove('hidden');
        }

        function resetPlayerStats(playerName) {
            if (!allPlayersData[playerName]) return;
            
            const resetData = JSON.parse(JSON.stringify(DEFAULT_PLAYER_DATA));
            allPlayersData[playerName] = resetData;
            saveAllData();
            
            if (playerName === currentPlayerName) {
                globalData = allPlayersData[playerName];
                applyBackgroundColor(globalData.backgroundColor);
                renderGrids();
            }

            showMessage(`Stats reset for ${playerName}.`);
        }

        function handleDeleteClick(btn) {
            const player = btn.dataset.player;
            
            requestAdminAuth(() => {
                deletePlayer(player);
                const row = btn.closest('div.flex');
                if(row) row.remove();
                if (managePlayersList.children.length === 0) {
                     managePlayersList.innerHTML = '<p class="text-gray-500 italic text-center p-4">No players found.</p>';
                }
            });
        }

        function deletePlayer(playerName) {
            if (allPlayersData[playerName]) {
                const wasActive = playerName === currentPlayerName; 

                delete allPlayersData[playerName];
                saveAllData();
                
                if (wasActive) {
                    currentPlayerName = null;
                    globalData = JSON.parse(JSON.stringify(DEFAULT_PLAYER_DATA));
                    
                    currentPlayerDisplay.textContent = "Please Select Player";
                    progressPlayerName.textContent = "Player";
                    calcPlayerBrand.textContent = "PLAYER";
                    showRawDataButton.disabled = true;

                    applyBackgroundColor(DEFAULT_PLAYER_DATA.backgroundColor); 
                    renderGrids();
                    updateSelectedTables(); 
                }
                
                refreshPlayerList(); 
                showMessage(`${playerName} deleted.`);
            }
        }

        // --- HELPER FUNCTIONS ---

        function showMessage(text, isSuccess = true) {
            if (isRestoring) return; 
            messageBox.textContent = text;
            messageBox.className = `fixed top-4 right-4 text-white p-4 rounded-xl shadow-2xl z-50 transition-all duration-300 transform ${isSuccess ? 'bg-green-600' : 'bg-red-600'} translate-x-0`;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
                setTimeout(() => messageBox.classList.add('hidden'), 500);
            }, 3000);
        }

        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        function updateLabelClass(checkbox) {
            const label = checkbox.closest('label');
            const span = label.querySelector('span');

            const commonClasses = ['bg-indigo-600', 'bg-white', 'text-white', 'text-gray-700', 'border-indigo-600', 'border-gray-300', 'ring-4', 'ring-indigo-200'];
            label.classList.remove(...commonClasses);
            span.classList.remove('text-white', 'text-gray-700');


            if (checkbox.checked) {
                label.classList.add('bg-indigo-600', 'border-indigo-600', 'ring-4', 'ring-indigo-200');
                span.classList.add('text-white');
            } else {
                label.classList.add('bg-white', 'border-gray-300'); 
                span.classList.add('text-gray-700');
            }
        }

        function updateSelectedTables() {
            selectedTables = Array.from(document.querySelectorAll('.table-checkbox:checked'))
                .map(cb => parseInt(cb.dataset.table));

            const isReady = selectedTables.length > 0 && currentPlayerName !== null && isDataLoaded;

            if (isReady) {
                startQuizButton.disabled = false;
                startQuizButton.textContent = `Start Quiz`; // Reflect total questions
            } else if (currentPlayerName === null) {
                startQuizButton.disabled = true;
                startQuizButton.textContent = `Select Player to Start`;
            } else if (!isDataLoaded) {
                 startQuizButton.disabled = true;
                 startQuizButton.textContent = `Loading Data...`;
            } else {
                startQuizButton.disabled = true;
                startQuizButton.textContent = `Select Tables to Start`; 
            }
        }

        function getAverageTime(timeData) {
            if (!timeData) return 0;
            
            if (timeData.history && Array.isArray(timeData.history) && timeData.history.length > 0) {
                const sum = timeData.history.reduce((a, b) => a + b, 0);
                return sum / timeData.history.length;
            }
            
            // Fallback for extremely old data (should be migrated by now)
            if (timeData.totalTime !== undefined && timeData.count > 0) {
                return timeData.totalTime / timeData.count;
            }
            
            return 0;
        }

        function calculateWeight(A, B, operation) {
            const key = `${A}_${B}`;
            const dataSet = operation === 'mul' ? globalData.mulTimes : globalData.divTimes;
            const timeObj = dataSet[key];
            
            if (!timeObj || timeObj.count === 0) return systemParams.weightFactorNew; 

            const avgTime = getAverageTime(timeObj);

            if (avgTime >= systemParams.weightThresholdRed) return systemParams.weightFactorPoor;
            else if (avgTime >= systemParams.weightThresholdYellow) return systemParams.weightFactorIntermediate;
            else return WEIGHT_FACTOR_GOOD;
        }

        function generateQuizQuestions() {
            quizQuestions = [];
            if (selectedTables.length === 0) return;

            const totalQuestionsToGenerate = systemParams.totalQuestions;

            const operationsToInclude = [];
            currentOperationMode = document.querySelector('input[name="operation-mode"]:checked').value;

            if (currentOperationMode === 'multiplication' || currentOperationMode === 'both') operationsToInclude.push('mul');
            if (currentOperationMode === 'division' || currentOperationMode === 'both') operationsToInclude.push('div');

            const weightedPool = [];

            selectedTables.forEach(A => {
                for (let B = 1; B <= 12; B++) {
                    if (operationsToInclude.includes('mul')) {
                        const weightAB = calculateWeight(A, B, 'mul'); 
                        const countAB = Math.round(weightAB); 
                        for (let i = 0; i < countAB; i++) weightedPool.push({ operation: 'mul', factor1: A, factor2: B });
                        
                        const weightBA = calculateWeight(B, A, 'mul'); 
                        const countBA = Math.round(weightBA); 
                        for (let i = 0; i < countBA; i++) weightedPool.push({ operation: 'mul', factor1: B, factor2: A });
                    }
                    if (operationsToInclude.includes('div')) {
                        const weightDiv = calculateWeight(A, B, 'div');
                        const countDiv = Math.round(weightDiv *2);
                        for (let i = 0; i < countDiv; i++) weightedPool.push({ operation: 'div', divisor: A, answer: B });
                    }
                }
            });

            console.log('Total Weighted Pool Size:', weightedPool.length);
            
            for (let i = 0; i < totalQuestionsToGenerate; i++) {
                if (weightedPool.length === 0) break;
                const poolIndex = randomInt(0, weightedPool.length - 1);
                const selected = weightedPool[poolIndex];
                let question = { timeTaken: 0, correct: false, userAnswer: null, operation: selected.operation };

                if (selected.operation === 'mul') {
                    question.factor1 = selected.factor1;
                    question.factor2 = selected.factor2;
                    question.answer = question.factor1 * question.factor2;
                } else { 
                    question.divisor = selected.divisor;
                    question.answer = selected.answer;
                    question.dividend = question.divisor * question.answer;
                }
                quizQuestions.push(question);
            }
        }

        function saveQuizState() {
            if (!quizQuestions || quizQuestions.length === 0 || !currentPlayerName) return;
            const state = {
                name: currentPlayerName,
                mode: currentOperationMode,
                tables: selectedTables,
                index: currentQuestionIndex,
                questions: quizQuestions,
                score: score
            };
            try { sessionStorage.setItem(QUIZ_STATE_KEY, JSON.stringify(state)); } catch (e) { console.error(e); }
        }

        function restoreQuizState() {
            try {
                const savedState = sessionStorage.getItem(QUIZ_STATE_KEY);
                if (!savedState) return false;
                const state = JSON.parse(savedState);
                
                // Only restore if this player exists in local data
                if (!allPlayersData[state.name]) {
                    sessionStorage.removeItem(QUIZ_STATE_KEY);
                    return false;
                }

                isRestoring = true;
                setPlayerProfile(state.name, true); 
                currentOperationMode = state.mode;
                
                selectedTables = state.tables;
                selectedTables.forEach(table => {
                    const checkbox = document.querySelector(`.table-checkbox[data-table="${table}"]`);
                    if (checkbox) { checkbox.checked = true; updateLabelClass(checkbox); }
                });

                const modeRadio = document.querySelector(`input[name="operation-mode"][value="${state.mode}"]`);
                if (modeRadio) modeRadio.checked = true;

                currentQuestionIndex = state.index;
                quizQuestions = state.questions;
                score = state.score;
                
                // Ensure we are on the quiz page when restoring
                showPage('quiz');
                
                pageHeader.classList.add('hidden');
                selectionPanel.classList.add('hidden');
                // selectionPlayerDisplay.classList.add('hidden'); // No longer needed
                quizPanel.classList.remove('hidden');
                setQuizActiveState(true); // Disable admin buttons on restore
                renderQuestion(); 
                showMessage(`Quiz restored for ${state.name} at question ${currentQuestionIndex + 1}.`, true);
                isRestoring = false; 
                return true;
            } catch (e) {
                console.error("Error restoring quiz state:", e);
                sessionStorage.removeItem(QUIZ_STATE_KEY);
                isRestoring = false;
                return false;
            }
        }
        
        // --- CALCULATOR INPUT FUNCTIONS ---

        function addCalcInput(value) {
            // Prevent multiple decimals
            if (value === '.' && currentCalcInput.includes('.')) return;
            // Prevent length overflow (aesthetic)
            if (currentCalcInput.length > 8) return; 

            currentCalcInput += value;
            updateCalcDisplay();
        }

        function clearCalcInput() {
            currentCalcInput = "";
            updateCalcDisplay();
        }

        function deleteLastCalcInput() {
            currentCalcInput = currentCalcInput.slice(0, -1);
            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            // Blink cursor effect if empty
            answerInputDisplay.textContent = currentCalcInput === "" ? "_" : currentCalcInput;
        }

        // --- QUIZ FUNCTIONS ---

        function renderQuestion() {
            const totalQuestions = quizQuestions.length;
            if (currentQuestionIndex >= totalQuestions) {
                sessionStorage.removeItem(QUIZ_STATE_KEY); 
                return showResults();
            }

            // Remove flash classes if any leftover
            calcScreen.classList.remove('correct-flash', 'wrong-flash');

            currentQuestion = quizQuestions[currentQuestionIndex];
            
            // Update Top Bar
            calcProgressLabel.textContent = `Q: ${currentQuestionIndex + 1}/${totalQuestions}`;
            
            let questionString = '';
            if (currentQuestion.operation === 'mul') {
                questionString = `${currentQuestion.factor1} x ${currentQuestion.factor2}`;
            } else { 
                questionString = `${currentQuestion.dividend}  ${currentQuestion.divisor}`;
            }

            questionText.textContent = questionString;
            
            // Clear input for new question
            clearCalcInput();
            
            awaitingNext = false;
            quizStartTime = Date.now();
        }

        function nextQuestion() {
            // Not used in manual flow anymore, called by timeout
            currentQuestionIndex++;
            saveQuizState();
            renderQuestion();
        }

        async function submitAnswer() {
            if (awaitingNext) return; // Prevent double submission during flash
            if (!currentPlayerName) { showMessage("Error: No Player", false); return; }

            const userAnswer = parseInt(currentCalcInput, 10);
            if (isNaN(userAnswer)) { 
                // Perhaps shake screen? For now just return.
                return; 
            }

            awaitingNext = true; // Lock input

            const actualTimeTaken = (Date.now() - quizStartTime) / 1000;
            currentQuestion.userAnswer = userAnswer;
            currentQuestion.correct = (userAnswer === currentQuestion.answer);

            let timeToRecord;
            let trackA, trackB;

            if (currentQuestion.operation === 'mul') {
                trackA = currentQuestion.factor1;
                trackB = currentQuestion.factor2;
            } else { 
                trackA = currentQuestion.divisor; 
                trackB = currentQuestion.answer; 
            }

            if (currentQuestion.correct) {
                score++;
                timeToRecord = parseFloat(actualTimeTaken.toFixed(2));
                currentQuestion.timeTaken = timeToRecord;
                calcScreen.classList.add('correct-flash');
            } else {
                timeToRecord = (typeof systemParams.penaltyTime === 'number') ? systemParams.penaltyTime : 10.00; 
                currentQuestion.timeTaken = timeToRecord;
                calcScreen.classList.add('wrong-flash');
            }
            
            updateTrackingData(trackA, trackB, timeToRecord, currentQuestion.operation); 

            // Automatically move to next question after flash
            setTimeout(() => {
                nextQuestion();
            }, 600); // 500ms for animation + buffer
        }

        function showResults() {
            sessionStorage.removeItem(QUIZ_STATE_KEY); 
            pageHeader.classList.remove('hidden');
            quizPanel.classList.add('hidden');
            resultsPanel.classList.remove('hidden');
            // selectionPlayerDisplay.classList.remove('hidden'); // REMOVED: Now inside selection panel
            setQuizActiveState(false); // Re-enable admin buttons

            // UPDATE RESULTS NAME
            const resultsPlayerName = document.getElementById('results-player-name');
            if(resultsPlayerName) resultsPlayerName.textContent = currentPlayerName;

            const completedQuestions = quizQuestions.filter(q => q.userAnswer !== null);
            resultsSummary.textContent = `You scored ${score} out of ${completedQuestions.length}!`;

            resultsDetails.innerHTML = completedQuestions.map((q) => {
                const questionOp = q.operation === 'mul' ? 'x' : '';
                const questionString = q.operation === 'mul' 
                    ? `${q.factor1} ${questionOp} ${q.factor2} = `
                    : `${q.dividend} ${questionOp} ${q.divisor} = `;
                
                let resultContent = '';
                let resultClass = '';

                if (q.correct) {
                    resultContent = `${q.answer} <span class="font-normal text-sm">(Correct, ${q.timeTaken.toFixed(2)}s)</span>`;
                    resultClass = 'text-green-700';
                } else {
                    resultContent = `<span class="font-bold">Your answer: ${q.userAnswer || 'N/A'}</span> <span class="ml-4 font-bold">Correct Answer: ${q.answer}</span>`;
                    resultClass = 'text-red-700';
                }

                return `<div class="mb-2 p-2 border-b last:border-b-0 ${resultClass}"><span class="font-semibold">${questionString}</span> ${resultContent}</div>`;
            }).join('');

            currentQuestionIndex = 0;
            score = 0;
            quizQuestions = [];
            awaitingNext = false;
        }

        function startNewQuiz() {
            sessionStorage.removeItem(QUIZ_STATE_KEY);
            pageHeader.classList.remove('hidden');
            resultsPanel.classList.add('hidden');
            quizPanel.classList.add('hidden');
            selectionPanel.classList.remove('hidden');
            // selectionPlayerDisplay.classList.remove('hidden'); // Not needed
            setQuizActiveState(false); // Re-enable admin buttons
            document.querySelectorAll('.table-checkbox').forEach(cb => { cb.checked = false; updateLabelClass(cb); });
            updateSelectedTables();
        }

        function startQuiz() {
            if (selectedTables.length === 0) return;
            if (!currentPlayerName) { showMessage("Please select or create a player profile first.", false); return; }

            pageHeader.classList.add('hidden');
            // selectionPlayerDisplay.classList.add('hidden'); // Not needed
            generateQuizQuestions();
            selectionPanel.classList.add('hidden');
            quizPanel.classList.remove('hidden');
            setQuizActiveState(true); // Disable admin buttons
            renderQuestion();
            saveQuizState(); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // --- RAW DATA MODAL FUNCTIONS ---

        function showRawDataModal() {
            if (!currentPlayerName) {
                showMessage("Please select a player profile first.", false);
                return;
            }
            
            modalPlayerName.textContent = currentPlayerName;
            rawDataError.classList.add('hidden'); 
            
            // NOTE: GlobalData contains the current active player's data
            const formattedJson = JSON.stringify(globalData, null, 2); 
            rawDataContent.value = formattedJson; 
            
            rawDataModal.classList.remove('hidden');
        }

        function closeRawDataModal() {
            rawDataModal.classList.add('hidden');
        }
        
        function saveRawDataChanges() {
            if (!currentPlayerName) {
                showMessage("No player selected.", false);
                return;
            }
            
            const rawJsonString = rawDataContent.value;
            let newPlayerData;
            
            try {
                newPlayerData = JSON.parse(rawJsonString);
            } catch (e) {
                rawDataError.textContent = "Error: Invalid JSON format. Please check syntax (commas, quotes, brackets).";
                rawDataError.classList.remove('hidden');
                return;
            }
            
            if (typeof newPlayerData !== 'object' || newPlayerData === null || 
                !newPlayerData.mulTimes || !newPlayerData.divTimes) {
                rawDataError.textContent = "Error: Data structure is incomplete. Must contain mulTimes and divTimes objects.";
                rawDataError.classList.remove('hidden');
                return;
            }
            
            saveModalButton.disabled = true;
            rawDataError.classList.add('hidden');
            
            try {
                // Update global data and save to main storage object
                globalData = newPlayerData;
                allPlayersData[currentPlayerName] = globalData;
                saveAllData();
                
                closeRawDataModal();
                showMessage(`Raw data successfully saved for ${currentPlayerName}.`, true);
                // Important: Apply new background color if it was changed via raw data
                if (globalData.backgroundColor) {
                    applyBackgroundColor(globalData.backgroundColor);
                }
                renderGrids();
            } catch (error) {
                console.error("Error saving raw tracking data:", error);
                rawDataError.textContent = `Error saving: ${error.message}.`;
                rawDataError.classList.remove('hidden');
            } finally {
                saveModalButton.disabled = false;
            }
        }


        // --- TRACKING UPDATE LOGIC (LOCAL) ---

        function updateTrackingData(A, B, timeToRecord, operation) {
            if (!currentPlayerName) return;

            const canonicalKey = `${A}_${B}`;
            const timeField = operation === 'mul' ? 'mulTimes' : 'divTimes';
            const timeData = globalData[timeField][canonicalKey];
            
            if (timeData) {
                if (!timeData.history) timeData.history = [];
                
                // Add new time to history
                timeData.history.push(timeToRecord);
                
                // Trim to window size (Keep last 5)
                if (timeData.history.length > ROLLING_WINDOW) {
                    timeData.history.shift(); 
                }
                
                // Cleanup legacy fields if present
                if (timeData.totalTime !== undefined) delete timeData.totalTime;

                timeData.count = (timeData.count || 0) + 1;
            } else {
                globalData[timeField][canonicalKey] = { history: [timeToRecord], count: 1 };
            }
            
            // Recalculate total answered
            let totalAnswered = 0;
            for (const key in globalData.mulTimes) totalAnswered += globalData.mulTimes[key].count || 0;
            for (const key in globalData.divTimes) totalAnswered += globalData.divTimes[key].count || 0;
            globalData.totalAnswered = totalAnswered;

            // Commit to Local Storage
            allPlayersData[currentPlayerName] = globalData;
            saveAllData();
            
            // Re-render grids to show updates immediately
            renderGrids();
        }

        // --- GRID RENDERING ---

        function renderGrids() {
            totalQuestionsAnsweredDisplay.textContent = globalData.totalAnswered.toLocaleString();
            renderGrid('time-grid', 'mul');
            renderGrid('div-time-grid', 'div');
        }

        function renderGrid(containerId, operation) {
            const container = document.getElementById(containerId);
            let html = '';
            const dataSet = operation === 'mul' ? globalData.mulTimes : globalData.divTimes;
            
            html += `<div class="flex flex-row flex-nowrap w-full">`;
            const labelText = operation === 'mul' ? 'F2\\F1' : 'A\\D'; 
            html += `<div class="grid-cell bg-gray-300 border border-gray-400 text-xs font-bold flex-1">${labelText}</div>`; 
            for (let A = 1; A <= 12; A++) { 
                html += `<div class="grid-cell bg-gray-300 border border-gray-400 text-xs font-bold flex-1">${A}</div>`;
            }
            html += `</div>`;

            for (let B = 1; B <= 12; B++) { 
                html += `<div class="flex flex-row flex-nowrap w-full">`;
                html += `<div class="grid-cell bg-gray-300 border border-gray-400 text-xs font-bold flex-1">${B}</div>`;

                for (let A = 1; A <= 12; A++) { 
                    const canonicalKey = `${A}_${B}`;
                    let displayValue = '-';
                    let colorClass = 'bg-white';
                    let questionTooltip = operation === 'mul' ? `${A} x ${B} = ${A*B}` : `${A*B}  ${A} = ${B}`;
                    let tooltip = `Fact: ${questionTooltip}`;

                    const timeObj = dataSet[canonicalKey];
                    if (timeObj && timeObj.count > 0) {
                        const avgTime = getAverageTime(timeObj);
                        
                        displayValue = `${avgTime.toFixed(1)}`;
                        tooltip += `\nRolling Avg: ${avgTime.toFixed(2)}s (Last ${timeObj.history ? timeObj.history.length : 0} attempts)`;
                        tooltip += `\nTotal Answered: ${timeObj.count}`;
                        
                        if (avgTime < systemParams.weightThresholdYellow) colorClass = 'bg-green-200';
                        else if (avgTime < systemParams.weightThresholdRed) colorClass = 'bg-yellow-200';
                        else colorClass = 'bg-red-200';
                    } else {
                        tooltip += `\nNo data yet`;
                    }

                    html += `<div class="grid-cell border border-gray-300 ${colorClass} text-gray-800 hover:scale-105 flex-1" title="${tooltip}">${displayValue}</div>`;
                }
                html += `</div>`;
            }
            container.innerHTML = html;
        }

        // --- INIT ---

        function renderTableCheckboxes() {
            tableCheckboxContainer.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const checkboxHtml = `
                    <label 
                        data-table-label="${i}"
                        class="table-label flex items-center justify-center p-2 rounded-lg border-2 transition duration-150 cursor-pointer shadow-sm"
                    >
                        <input type="checkbox" data-table="${i}" class="table-checkbox hidden">
                        <span class="text-lg font-semibold">${i}</span>
                    </label>
                `;
                tableCheckboxContainer.insertAdjacentHTML('beforeend', checkboxHtml);
            }

            document.querySelectorAll('.table-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    updateSelectedTables();
                    updateLabelClass(e.target);
                });
                updateLabelClass(checkbox);
            });
        }


        window.onload = () => {
            loadAllData();
            updateQuizUIParams(); // Load initial total questions number
            refreshPlayerList();
            renderTableCheckboxes();
            renderGrids(); 
            
            // Restore session if exists
            restoreQuizState();
            
            // --- NEW PLAYER MODAL LISTENERS ---
            showNewPlayerModalButton.addEventListener('click', showNewPlayerModal);
            closeNewPlayerModalButton.addEventListener('click', closeNewPlayerModal);
            
            newPlayerModal.addEventListener('click', (e) => {
                if (e.target === newPlayerModal) { closeNewPlayerModal(); }
            });
            
            setNewPlayerButton.addEventListener('click', validateAndCreatePlayer);
            
            newPlayerNameInput.addEventListener('input', (e) => { 
                const name = e.target.value.trim();
                const isValid = name.length >= 2;
                setNewPlayerButton.disabled = !isValid;
                newPlayerError.classList.toggle('hidden', isValid);
            });
            
            newPlayerNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && setNewPlayerButton.disabled === false) { 
                    e.preventDefault(); 
                    validateAndCreatePlayer();
                }
            });

            // --- PLAYER SELECT DROPDOWN LISTENER ---
            playerSelect.addEventListener('change', (e) => {
                const selectedName = e.target.value;
                if (selectedName) {
                    setPlayerProfile(selectedName);
                }
            });

            // --- NAVIGATION LISTENERS ---
            toStatsBtn.addEventListener('click', () => showPage('stats'));
            toQuizBtn.addEventListener('click', () => showPage('quiz'));

            // --- TABLE SELECTION BUTTONS ---
            const btnSelectAll = document.getElementById('btn-select-all');
            const btnSelectNone = document.getElementById('btn-select-none');
            const btnLuckyDip = document.getElementById('btn-lucky-dip');

            btnSelectAll.addEventListener('click', () => {
                document.querySelectorAll('.table-checkbox').forEach(cb => {
                    cb.checked = true;
                    updateLabelClass(cb);
                });
                updateSelectedTables();
            });

            btnSelectNone.addEventListener('click', () => {
                 document.querySelectorAll('.table-checkbox').forEach(cb => {
                    cb.checked = false;
                    updateLabelClass(cb);
                });
                updateSelectedTables();
            });

            btnLuckyDip.addEventListener('click', () => {
                const checkboxes = Array.from(document.querySelectorAll('.table-checkbox'));
                // Reset
                checkboxes.forEach(cb => { cb.checked = false; updateLabelClass(cb); });
                
                // Random number of tables (1 to 12)
                const numberOfTables = Math.floor(Math.random() * 12) + 1;
                
                // Shuffle and slice
                const shuffled = checkboxes.sort(() => 0.5 - Math.random());
                
                shuffled.slice(0, numberOfTables).forEach(cb => {
                    cb.checked = true;
                    updateLabelClass(cb);
                });
                updateSelectedTables();
            });


            document.querySelectorAll('input[name="operation-mode"]').forEach(radio => {
                radio.addEventListener('change', (e) => { currentOperationMode = e.target.value; });
            });

            startQuizButton.addEventListener('click', startQuiz);
            newQuizButton.addEventListener('click', startNewQuiz); 
            endQuizButton.addEventListener('click', showResults);
            
            // --- MANAGE PLAYERS LISTENERS ---
            managePlayersButton.addEventListener('click', openManagePlayersModal);
            closeManageModalButton.addEventListener('click', () => managePlayersModal.classList.add('hidden'));
            managePlayersModal.addEventListener('click', (e) => {
                if(e.target === managePlayersModal) managePlayersModal.classList.add('hidden');
            });
            
            // --- COLOR MODAL LISTENERS ---
            showColorModalButton.addEventListener('click', openColorModal);
            closeColorModalButton.addEventListener('click', closeColorModal);
            cancelColorButton.addEventListener('click', closeColorModal);

            colorModal.addEventListener('click', (e) => {
                if(e.target === colorModal) closeColorModal();
            });

            // Slider update event listeners (live preview)
            [sliderR, sliderG, sliderB].forEach(slider => {
                slider.addEventListener('input', updateColorDisplay);
            });

            // Apply button handler
            applyColorButton.addEventListener('click', () => {
                if (!currentPlayerName) { 
                    showMessage("Please select a player before setting a custom color.", false); 
                    return; 
                }
                const r = sliderR.value;
                const g = sliderG.value;
                const b = sliderB.value;
                const newColor = `rgb(${r}, ${g}, ${b})`;
                
                savePlayerColorPreference(newColor);
                
                closeColorModal();
                showMessage(`Background color applied: RGB(${r}, ${g}, ${b})`, true);
            });


            // --- QUIZ SETUP LISTENERS ---
            showQuizSetupButton.addEventListener('click', openQuizSetupModal);
            closeQuizSetupButton.addEventListener('click', closeQuizSetupModal);
            quizSetupModal.addEventListener('click', (e) => {
                if(e.target === quizSetupModal) closeQuizSetupModal();
            });
            resetSystemParamsButton.addEventListener('click', resetSystemParams);
            
            // Use the form submit event to handle validation and saving
            quizSetupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                saveSystemParams();
            });

            // --- RAW DATA LISTENERS ---
            showRawDataButton.addEventListener('click', showRawDataModal);
            closeModalButton.addEventListener('click', closeRawDataModal);
            
            // Updated to use Admin Auth instead of direct save
            saveModalButton.addEventListener('click', (e) => {
                 requestAdminAuth(saveRawDataChanges);
            }); 
            
            rawDataModal.addEventListener('click', (e) => {
                if (e.target === rawDataModal) { closeRawDataModal(); }
            });

            // --- ADMIN AUTH LISTENERS (NEW) ---
            adminCodeAuthInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') confirmAdminAuth();
            });

            // --- GLOBAL KEYBOARD LISTENERS FOR CALCULATOR ---
            // Attached to window/document to catch keystrokes when quiz is active
            document.addEventListener('keydown', (e) => {
                // Only active if the quiz panel is visible and not waiting for transition
                const isQuizActive = !quizPanel.classList.contains('hidden') && !awaitingNext;
                
                if (!isQuizActive) return;

                // Handle numbers (Numpad or Top row)
                if ((e.key >= '0' && e.key <= '9') || e.key === '.') {
                    addCalcInput(e.key);
                }
                
                // Handle Enter
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitAnswer();
                }

                // Handle Backspace
                if (e.key === 'Backspace') {
                    deleteLastCalcInput();
                }

                // Handle Escape/Clear
                if (e.key === 'Escape') {
                    clearCalcInput();
                }
            });

            // Apply default color on load if no user is yet selected
            if (!currentPlayerName) {
                applyBackgroundColor(DEFAULT_PLAYER_DATA.backgroundColor);
            }
        };

        //splash screen and backbutton-exit solution

        const splash = document.getElementById('splashScreen');
        const enterBtn = document.getElementById('enterBtn');
        const exitModal = document.getElementById('exitModal');
        const stayBtn = document.getElementById('stayBtn');
        const leaveBtn = document.getElementById('leaveBtn');

        let guardActive = false;

        // 1. Initialize protection on "Enter"
        enterBtn.addEventListener('click', () => {
            // Permission granted by user click
            window.history.pushState({ protected: true }, "");
            guardActive = true;

            // Visual transition
            splash.classList.add('fade-out');
            setTimeout(() => splash.style.display = 'none', 500);
        });

        // 2. Intercept Back Gesture
        window.addEventListener('popstate', (event) => {
            if (guardActive) {
                // Show custom alert
                exitModal.style.display = 'flex';
                
                // Push state back so the next swipe also hits popstate
                window.history.pushState({ protected: true }, "");
            }
        });

        // 3. Stay Button logic
        stayBtn.addEventListener('click', () => {
            exitModal.style.display = 'none';
        });

        // 4. Leave Button logic (Commented out in original but preserved logic here)
        /*leaveBtn.addEventListener('click', () => {
            guardActive = false;
            // Try to close, if it fails (security), go to blank page
            window.close();
            location.href = "about:blank";
        });*/

        // 5. Native Backup (Tab close/Refresh)
        window.onbeforeunload = function(e) {
            if (guardActive) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        };

    </script>
</body>
</html>
